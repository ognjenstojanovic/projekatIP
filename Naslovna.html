<html><head><!-- meta ignored --><link rel="stylesheet" type="text/css" href="css/site.css"></link><meta http-equiv="content-type" content="text/html; charset=UTF-8" />

<link rel="shortcut icon" href="pages/favicon.ico" type="image/x-icon"></head><body>

<?php 

if (isset($_POST["unesiVest"])){
	
	$servername = "localhost";
	$username = "G23";
	$password = "123";
	$defaultDatabase = "portalvesti";
	
	// Create connection
	$conn = new mysqli($servername, $username, $password, $defaultDatabase);
	// Check connection
	if ($conn->connect_error) {
		die("Connection failed: " . $conn->connect_error);		
	}
	
	$NaslovVesti = $_POST["naslovVesti"];
	$kategorija = $_POST["kategorija"];
	$podkategorija = $_POST["podkategorija"];
	$tekstVesti = $_POST["tekstVesti"];	

	$id = 0;

	$maxIdQuery = "SELECT MAX(IDVesti) as Id FROM Vesti";

	$maxIdResult = $conn->query($maxIdQuery);

	if($row1 = $maxIdResult->fetch_assoc()){
		$id = $row1["Id"] + 1;
	}
	
	
	$filename = $id . ".html";
	$link = "pages/news/" . $filename;
	
	$newFile = fopen($link, "w");
	
	$contents = file_get_contents('pages/VestTemplate.html');
	
	$contents = str_replace("{title}",$NaslovVesti,$contents);
	$contents = str_replace("{datum}", date("d.m.y"), $contents);
	$contents = str_replace("{tekstVesti}",$tekstVesti,$contents);

	$filename = "images/";
	$linkToImage = "";

	$ROOT = "images";
	foreach($_FILES as $file => $details)
	{   // Move each file from its temp directory to $ROOT
		$temp = $details['tmp_name'];
		$target = $details['name'];
		$filename .= $target;
		move_uploaded_file($temp, $ROOT.'/'.$target);
	}

	if(file_exists($filename))
	{
		$linkToImage = "../../" . $filename;
	}
	else
	{
		$linkToImage = "../../images/GenericImage.jpg";
	}

	$contents = str_replace("{link}",$linkToImage,$contents);

	fwrite($newFile, $contents);
	
	fclose($newFile);
	
	session_start();
	$idKorisnika = $_SESSION['IDKorisnika'];
	
	$sqlQuery = "INSERT INTO vesti (Naslov, 
									Kategorija, 
									Podkategorija,
									BrojLajkova,
									BrojHejtova,
									Link,
									SlikaLink,
									IDKorisnika)
							 Values('$NaslovVesti',
									'$kategorija',
									'$podkategorija',
									0,
									0,
									'$link',
									'$linkToImage',
									$idKorisnika)";

	if ($conn->query($sqlQuery) === TRUE) {		
	} else {
		echo "<h1>Error inserting news: " . $conn->error . "</h1>";
	}
	
	if ($conn->connect_error) {
		die("Connection failed: " . $conn->connect_error);		
	}
	
	$conn->close();		
									
}
else{
	
}

$servername = "localhost";
$username = "G23";
$password = "123";
$defaultDatabase = "portalvesti";
	
// Create connection
$conn1 = new mysqli($servername, $username, $password, $defaultDatabase);
// Check connection
if ($conn1->connect_error) {
	die("Connection failed: " . $conn->connect_error);		
}

$mostLikesQuery = 'SELECT * FROM Vesti ORDER BY BrojLajkova DESC LIMIT 5';
$mostCommentsQuery = 'SELECT * FROM Vesti ORDER BY (SELECT COUNT(*) FROM Komentari WHERE IDVesti = Vesti.IDVesti) DESC LIMIT 5';
	
$mostLikesResult = $conn1->query($mostLikesQuery);

echo '<h3>' . $conn1->error . '</h3>';

$mostCommentsResult = $conn1->query($mostCommentsQuery);

echo '<h3>' . $conn1->error . '</h3>';

?>


<div id="wrapper">
	<table id="topTable">
		<tr>
			<td style="width: 50%">	
				
				<p id="blockTitle">Najviše lajkova</p>
				
				<ul>						
						<?php 
						
							while($row = $mostLikesResult->fetch_assoc())
							{
								echo '<li><a href="' . $row["Link"] . '">' . $row["Naslov"] . '</a></li>';
							}						
						
						?>
				</ul>
					
			</td>
			<td style="width: 50%">
						
				<p id="blockTitle">Najviše komentara</p>										

				<ul>
						<?php 
						
							while($row = $mostCommentsResult->fetch_assoc())
							{
								echo '<li><a href="' . $row["Link"] . '">' . $row["Naslov"] . '</a></li>';
							}						
							
							$conn1->close();
							
						?>
				</ul>
				
			</td>
		</tr>
	</table>
   
   <?php
   		include 'php/MeniNaslovna.php';
   ?>
	
	<table id="bottomTable">
		<tr>
			<td class="bottomTableTd">
				<p id="blockTitle">
					<h4 style="text-align: center; padding-top: 10px; ">
						<a href="pages/news/KategorijaEkonomija.html">Ekonomija</a>
					</h4>
				</p>
					
				<?php
					include 'php/NewsListFunction.php';
					
					ListNews("Ekonomija");
				?>
 
			</td>
			<td class="bottomTableTd">
				<h4 style="text-align: center; padding-top: 10px; ">
					<a href="pages/news/KategorijaPrivreda.html">Privreda</a>
				</h4>
				
				
				<?php
					ListNews("Privreda");
				?>
				
				
			</td>
			<td class="bottomTableTd">
				<h4 style="text-align: center; padding-top: 10px; ">
					<a href="pages/news/KategorijaFinansije.html">Finansije</a>
				</h4>
				
				
				<?php
					ListNews("Finansije");
				?>
				
				
			</td>
		</tr>
		<tr>
			<td class="bottomTableTd">
				<h4 style="text-align: center; padding-top: 10px; ">
					<a href="pages/news/KategorijaPolitika.html">Politika</a>
				</h4>
				
				
				<?php
					ListNews("Politika");
				?>
				
				
			</td>
			<td class="bottomTableTd">
				<h4 style="text-align: center; padding-top: 10px; ">
					<a href="pages/news/KategorijaKultura.html">Kultura</a>
				</h4>
				
				
				<?php
					ListNews("Kultura");
				?>
			
				
			</td>
			<td class="bottomTableTd">
				<h4 style="text-align: center; padding-top: 10px; ">
					<a href="pages/news/KategorijaTehnologija.html">Tehnologije</a>
				</h4>
				
				
				<?php
					ListNews("Tehnologije");
				?>
				
				
			</td>
		</tr>
		<tr>
			<td class="bottomTableTd">
				<h4 style="text-align: center; padding-top: 10px; ">
					<a href="pages/news/KategorijaSport.html">Sport</a>
				</h4>
				
				
				<?php
					ListNews("Sport");
				?>
				
				
			</td>
			<td class="bottomTableTd">
				<h4 style="text-align: center; padding-top: 10px; ">
					<a href="pages/news/KategorijaFudbal.html">Fudbal</a>
				</h4>
				
				
				<?php
					ListNews("Fudbal");
				?>
				
				
			</td>
			<td class="bottomTableTd">
				<h4 style="text-align: center; padding-top: 10px; ">
					<a href="pages/news/KategorijaKosarka.html">Košarka</a>
				</h4>
				
				
				<?php
					ListNews("Kosarka");
				?>
				
				
			</td>
		</tr>
	</table>

	 
	
</div>

</body></html>